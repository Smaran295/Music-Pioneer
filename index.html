<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Pioneer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    /* your existing styles kept, minor cleanup */
    body { font-family: Arial, sans-serif; background:#121212; color:#fff; margin:0; height:100vh; overflow:hidden; }
    #sidebar{width:200px;background:#1a1a1a;height:100vh;position:fixed;transition:width .3s}
    .logo{padding:20px;text-align:center;font-size:24px;color:#1DB954}
    .nav-item{display:block;padding:15px;color:#B3B3B3;text-decoration:none;border-bottom:1px solid #333;cursor:pointer}
    .nav-item:hover, .nav-item.active{background:#333;color:#1DB954}
    #mainContent{margin-left:200px;padding:20px;overflow-y:auto;height:100vh}
    .section{display:none}.section.active{display:block}
    h2{color:#1DB954;margin-bottom:20px}
    .song-card{background:#1a1a1a;padding:10px;margin:10px 0;border-radius:5px;cursor:pointer}
    .song-card:hover{background:#333}
    .song-card img{width:100%;height:100px;object-fit:cover;border-radius:5px}
    .details strong{color:#1DB954}
    .search-bar input{padding:10px;background:#1a1a1a;border:1px solid #333;color:white;width:70%}
    .search-bar button{padding:10px 20px;background:#1DB954;color:black;border:none;cursor:pointer}
    #playerBar{position:fixed;bottom:0;left:200px;right:0;height:60px;background:#1a1a1a;display:flex;align-items:center;padding:0 20px}
    .controls button{font-size:20px;background:none;border:none;color:#B3B3B3;margin:0 10px;cursor:pointer}
    .controls button:hover{color:#1DB954}
    #progress,#volume{width:200px;height:5px;background:#333}
    #currentSong{position:fixed;bottom:70px;left:220px;color:#B3B3B3}
    .loading{text-align:center;color:#B3B3B3;font-size:18px}
    .hamburger{display:none;position:fixed;top:10px;left:10px;font-size:24px;cursor:pointer;z-index:1000}
    @media(max-width:768px){#sidebar{width:0}#mainContent{margin-left:0}#playerBar{left:0}#currentSong{left:10px}.hamburger{display:block;color:#B3B3B3}}
  </style>
</head>
<body>
  <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
  <div id="sidebar">
    <div class="logo">Music Pioneer</div>
    <a href="#" class="nav-item active" onclick="showSection('home', this); return false;">Home</a>
    <a href="#" class="nav-item" onclick="showSection('search', this); return false;">Search</a>
    <a href="#" class="nav-item" onclick="showSection('library', this); return false;">Library</a>
  </div>

  <div id="mainContent">
    <div id="home" class="section active">
      <h2>Home</h2>
      <div class="song-card" onclick="playSong('Deva Deva', 'Arijit Singh', 'https://www.jiosaavn.com/song/deva-deva/RgIAQh7XZEw')">
        <strong>Deva Deva</strong> - Arijit Singh
      </div>
      <div class="song-card" onclick="playSong('Kesariya', 'Pritam', 'https://www.jiosaavn.com/song/kesariya/AgIAQyBeWlI')">
        <strong>Kesariya</strong> - Pritam
      </div>
    </div>

    <div id="search" class="section">
      <div class="search-bar">
        <input id="query" type="text" placeholder="Search songs..." onkeypress="if(event.key==='Enter') searchSongs()">
        <button onclick="searchSongs()">Search</button>
      </div>
      <div id="results"></div>
    </div>

    <div id="library" class="section">
      <h2>Library</h2>
      <div class="song-card" onclick="playSong('Liked Song','Various','https://www.jiosaavn.com/song/kesariya/AgIAQyBeWlI')">
        <strong>Liked Songs</strong> - Various
      </div>
    </div>
  </div>

  <div id="currentSong"></div>

  <div id="playerBar">
    <div class="controls" style="display:flex;align-items:center;width:100%;">
      <button onclick="toggleShuffle()" id="shuffleBtn">üîÄ</button>
      <button onclick="playPrevious()">‚èÆ</button>
      <button id="playBtn" onclick="togglePlay()">‚ñ∂</button>
      <button onclick="playNext()">‚è≠</button>
      <button onclick="toggleRepeat()" id="repeatBtn">üîÅ</button>
      <input id="progress" type="range" min="0" max="100" value="0" style="flex:1;margin:0 10px;">
      <button id="muteBtn" onclick="toggleMute()">üîä</button>
      <input id="volume" type="range" min="0" max="1" step="0.1" value="1">
    </div>
  </div>

  <script>
    // ---- Config ----
    const API_PROXY = '/api/song'; // serverless proxy (see api/song.js below)
    const JIOSAAVN_BASE = 'https://www.jiosaavn.com/api.php';
    // ---- State ----
    let currentAudio = null, queue = [], currentIndex = -1, isShuffling = false, isRepeating = false;

    // ---- Utilities ----
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.style.width = sidebar.style.width === '0px' ? '200px' : '0px';
    }

    // safer showSection: accepts the clicked element as second arg
    function showSection(section, el) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const sec = document.getElementById(section);
      if (sec) sec.classList.add('active');

      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      if (el instanceof HTMLElement) el.classList.add('active');
      else {
        // try to find nav by text fallback
        const nav = Array.from(document.querySelectorAll('.nav-item')).find(a => a.textContent.trim().toLowerCase() === section);
        if (nav) nav.classList.add('active');
      }
    }

    function extractPidsFromUrl(url) {
      if (!url) return null;
      try {
        const u = new URL(url);
        const parts = u.pathname.split('/').filter(Boolean);
        return parts.pop() || null;
      } catch (e) {
        const parts = url.split('/').filter(Boolean);
        return parts.pop() || null;
      }
    }

    // Try a robust decrypt (we try two parse modes because different wrappers use UTF8/Hex)
    function decryptMediaUrl(encryptedUrl) {
      if (!encryptedUrl) return null;
      try {
        // helper to attempt a decryption with chosen key/iv parse functions
        const attempt = (keyParser, ivParser) => {
          try {
            const key = keyParser('383465614859384b38343230');
            const iv = ivParser('0000000000000000');
            const cipherParams = CryptoJS.lib.CipherParams.create({ ciphertext: CryptoJS.enc.Base64.parse(encryptedUrl) });
            const decrypted = CryptoJS.DES.decrypt(cipherParams, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
            const plaintext = decrypted.toString(CryptoJS.enc.Utf8);
            if (plaintext && plaintext.length > 0) return plaintext.replace(/\0+$/g, '');
          } catch (e) { /* ignore */ }
          return null;
        };

        // Try UTF8 parse first, then Hex parse
        const tryUtf8 = attempt.bind(null, CryptoJS.enc.Utf8.parse, CryptoJS.enc.Utf8.parse);
        const tryHex  = attempt.bind(null, CryptoJS.enc.Hex.parse, CryptoJS.enc.Hex.parse);

        return tryUtf8() || tryHex() || null;
      } catch (err) {
        console.error('decryptMediaUrl overall failure', err);
        return null;
      }
    }

    // Primary: try to get stream via our serverless proxy (avoids CORS). If proxy not available, try direct JioSaavn (may be CORS-blocked)
    async function getStreamUrl(pids) {
      if (!pids) throw new Error('Missing pid');
      // 1) try local proxy first
      try {
        const proxyRes = await fetch(`${API_PROXY}?pids=${encodeURIComponent(pids)}`);
        if (proxyRes.ok) {
          const proxyJson = await proxyRes.json();
          // proxy returns the JioSaavn JSON - shape depends on the original API
          // extract song object robustly:
          let song = null;
          if (Array.isArray(proxyJson)) song = proxyJson[0];
          else if (proxyJson[pids]) song = proxyJson[pids];
          else song = Object.values(proxyJson)[0];

          if (song) {
            const enc = song.encrypted_media_url || song.encrypted_media_url_320 || song.encrypted_media_url_128;
            if (enc) {
              const dec = decryptMediaUrl(enc);
              if (dec) {
                // use 320 if possible
                return dec.replace(/\.mp3/, '.mp3?type=320') + '&_=' + Date.now();
              }
            }
            // if server proxy already gives direct url property, use it
            if (song.media_url) return song.media_url;
          }
        } else {
          console.warn('Proxy returned non-ok', proxyRes.status);
        }
      } catch (err) {
        console.warn('Proxy fetch failed (ok if no server function):', err);
      }

      // 2) try direct JioSaavn API from client (likely CORS blocked in many browsers)
      try {
        const res = await fetch(`${JIOSAAVN_BASE}?__call=song.getDetails&cc=in&_format=json&pids=${encodeURIComponent(pids)}`);
        if (!res.ok) throw new Error('JioSaavn fetch failed: ' + res.status);
        const data = await res.json();
        let song = Array.isArray(data) ? data[0] : (data[pids] || Object.values(data)[0]);
        const enc = song?.encrypted_media_url;
        if (!enc) throw new Error('No encrypted_media_url');
        const dec = decryptMediaUrl(enc);
        if (!dec) throw new Error('Decryption failed');
        return dec.replace(/\.mp3/, '.mp3?type=320') + '&_=' + Date.now();
      } catch (err) {
        console.error('getStreamUrl final error:', err);
        throw err; // let caller handle / show message
      }
    }

    // playback / queue functions
    async function playSong(title, artists, url, pids) {
      // Ensure we have pid
      if (!pids) pids = extractPidsFromUrl(url);
      if (!pids) {
        console.warn('No pid found for', title, url);
        // as a safe demo fallback you can push a public mp3, but don't auto-use the horse.mp3:
        return alert('Cannot find song id (pids). Use the search to find the song or set up the server proxy.');
      }
      try {
        const streamUrl = await getStreamUrl(pids);
        addToQueue(streamUrl, title, artists, url);
      } catch (err) {
        console.error('playSong failed:', err);
        alert('Unable to get stream for this track. See console for details.');
      }
    }

    function addToQueue(url, title, artists, fullUrl) {
      queue.push({ url, title, artists, fullUrl });
      console.log('Added to queue:', title);
      if (currentIndex === -1) playNext();
    }

    function playNext() {
      if (queue.length === 0) return;
      currentIndex = isShuffling ? Math.floor(Math.random() * queue.length) : ((currentIndex + 1) % queue.length);
      playQueue();
    }

    function playPrevious() {
      if (queue.length === 0) return;
      currentIndex = currentIndex > 0 ? currentIndex - 1 : queue.length - 1;
      playQueue();
    }

    function playQueue() {
      if (currentIndex < 0 || currentIndex >= queue.length) return;
      const item = queue[currentIndex];
      console.log('Playing:', item.title, 'URL:', item.url);
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      currentAudio = new Audio(item.url);
      currentAudio.volume = parseFloat(document.getElementById('volume').value);
      document.getElementById('playBtn').textContent = '‚è∏';
      document.getElementById('currentSong').textContent = `${item.title} - ${item.artists}`;
      currentAudio.addEventListener('loadedmetadata', () => {
        currentAudio.play().catch(err => {
          console.error('Play failed:', err);
          document.getElementById('playBtn').textContent = '‚ñ∂';
          alert('Playback failed (probably CORS or unsupported URL). Use the server proxy (see README).');
        });
      }, { once: true });
      currentAudio.load();
      currentAudio.addEventListener('timeupdate', updateProgressBar);
      currentAudio.addEventListener('ended', () => {
        if (isRepeating) playQueue();
        else playNext();
      });
    }

    function togglePlay() {
      if (!currentAudio) return;
      if (currentAudio.paused) {
        currentAudio.play().catch(err => console.error('Toggle play failed:', err));
        document.getElementById('playBtn').textContent = '‚è∏';
      } else {
        currentAudio.pause();
        document.getElementById('playBtn').textContent = '‚ñ∂';
      }
    }

    function toggleMute() {
      if (!currentAudio) return;
      currentAudio.muted = !currentAudio.muted;
      document.getElementById('muteBtn').textContent = currentAudio.muted ? 'üîá' : 'üîä';
    }

    function toggleShuffle() {
      isShuffling = !isShuffling;
      document.getElementById('shuffleBtn').style.color = isShuffling ? '#1DB954' : '#B3B3B3';
    }

    function toggleRepeat() {
      isRepeating = !isRepeating;
      document.getElementById('repeatBtn').style.color = isRepeating ? '#1DB954' : '#B3B3B3';
    }

    function updateProgressBar() {
      const progress = document.getElementById('progress');
      if (currentAudio?.duration) {
        progress.value = (currentAudio.currentTime / currentAudio.duration) * 100;
      }
    }

    function seekAudio(value) {
      if (currentAudio && currentAudio.duration) {
        currentAudio.currentTime = (value / 100) * currentAudio.duration;
      }
    }

    function setVolume(value) {
      if (currentAudio) currentAudio.volume = parseFloat(value);
    }

    // ---- Search ----
    const API_BASE = 'https://annonymous-sage.vercel.app'; // optional external search API (your original)
    async function searchSongs() {
      const q = document.getElementById('query').value.trim();
      const results = document.getElementById('results');
      if (!q) return results.innerHTML = '<p>Enter a search term.</p>';
      results.innerHTML = '<p class="loading">Loading...</p>';
      try {
        // Try your external API first (if up). If you want local search proxy, replace with your own.
        const res = await fetch(`${API_BASE}/api/search?query=${encodeURIComponent(q)}`);
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        results.innerHTML = '';
        const songs = data.data?.songs?.results || [];
        if (songs.length === 0) return results.innerHTML = '<p>No results found.</p>';
        songs.slice(0, 10).forEach(song => {
          const pids = song.url ? extractPidsFromUrl(song.url) : null;
          const div = document.createElement('div');
          div.className = 'song-card';
          const imageUrl = song.image?.find(img => img.quality === '150x150')?.url || 'https://via.placeholder.com/100?text=Cover';
          div.innerHTML = `
            <img src="${imageUrl}" alt="${song.title}" onerror="this.src='https://via.placeholder.com/100?text=Cover'">
            <div class="details">
              <strong>${song.title || 'Unknown'}</strong><br>
              <span>${song.primaryArtists || 'Unknown'} ‚Ä¢ ${song.album || 'N/A'}</span>
            </div>
          `;
          div.onclick = () => playSong(song.title, song.primaryArtists, song.url, pids);
          results.appendChild(div);
        });
      } catch (err) {
        results.innerHTML = `<p>Error: ${err.message}</p>`;
        console.error('Search failed:', err);
      }
    }

    // ---- init ----
    document.getElementById('progress').oninput = (e) => seekAudio(e.target.value);
    document.getElementById('volume').oninput = (e) => setVolume(e.target.value);
    document.getElementById('query').oninput = debounce(() => searchSongs(), 500);
    // show home without using event
    showSection('home');

    // small debounce helper
    function debounce(fn, wait) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), wait); };
    }

    console.log('App initialized - ready.');

  </script>
</body>
</html>
