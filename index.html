<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicPioneer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen font-sans">
    <!-- Header -->
    <header class="flex justify-between items-center p-4 bg-gray-800 shadow-md">
        <div class="flex items-center">
            <span class="text-2xl mr-2">ðŸŽ§</span>
            <h1 class="text-xl font-bold">MusicPioneer</h1>
        </div>
        <div>
            <button class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded text-sm font-medium">Sign In with Google</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-grow overflow-hidden">
        <!-- Left Sidebar: Navigation and Playlists -->
        <aside class="w-72 bg-gray-800 p-6 flex-shrink-0 overflow-y-auto">
            <nav class="mb-8">
                <ul class="space-y-3">
                    <li><a href="#" onclick="showHome()" class="flex items-center text-lg hover:text-indigo-400"><i class="fa fa-home mr-3"></i>Home</a></li>
                    <li><a href="#" onclick="showLibrary()" class="flex items-center text-lg hover:text-indigo-400"><i class="fa fa-book mr-3"></i>Your Library</a></li>
                </ul>
            </nav>
            <div class="mb-6">
                <input id="search-input" type="text" placeholder="Search songs, artists, albums..." class="w-full p-3 rounded bg-gray-700 text-white border-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400 text-sm" autocomplete="off">
            </div>
            <h3 class="text-lg font-bold mb-3">Playlists</h3>
            <ul id="playlists-list" class="space-y-2">
                <!-- Populated by JavaScript -->
            </ul>
        </aside>

        <!-- Main Content: Home, Library, Search Results -->
        <main class="flex-grow p-6 overflow-y-auto">
            <!-- Home Section -->
            <section id="home-section" class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Good Evening</h2>
                <div id="home-playlists" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Populated by JavaScript -->
                </div>
            </section>

            <!-- Library Section -->
            <section id="library-section" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4">Your Library</h2>
                <div id="library-content" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Populated by JavaScript -->
                </div>
            </section>

            <!-- Search Results -->
            <section id="search-results-section" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Search Results</h2>
                <div id="search-results" class="space-y-2">
                    <!-- Populated by JavaScript -->
                </div>
            </section>
        </main>

        <!-- Right Sidebar: Now Playing / Queue -->
        <aside class="w-80 bg-gray-800 p-6 flex-shrink-0 overflow-y-auto hidden lg:block" id="queue-sidebar">
            <h2 class="text-xl font-bold mb-4">Now Playing</h2>
            <div class="mb-6">
                <div class="artwork w-full h-64 bg-gray-700 flex items-center justify-center text-6xl rounded-lg mb-4">ðŸŽ¶</div>
                <h3 id="np-title" class="font-bold text-lg">No Song Playing</h3>
                <p id="np-artist" class="text-gray-400">Select a Song</p>
                <p id="np-album" class="text-gray-500">N/A</p>
            </div>
            <h3 class="text-lg font-bold mb-3">Queue</h3>
            <ul id="queue-list" class="space-y-2">
                <!-- Populated by JavaScript -->
            </ul>
        </aside>
    </div>

    <!-- Bottom Player Bar -->
    <footer class="bg-gray-800 p-4 flex items-center justify-between border-t border-gray-700">
        <div class="flex items-center w-1/4">
            <div class="artwork w-12 h-12 bg-gray-700 flex items-center justify-center text-xl rounded mr-3">ðŸŽ¶</div>
            <div>
                <h4 id="song-title" class="font-bold text-sm">No Song Playing</h4>
                <p id="song-artist" class="text-gray-400 text-xs">Select a Song</p>
            </div>
        </div>
        <div class="flex flex-col items-center w-2/4">
            <div class="flex justify-center gap-3 mb-3">
                <button onclick="shuffle()" class="p-2 hover:text-indigo-400" title="Shuffle"><i class="fa fa-random"></i></button>
                <button onclick="previous()" class="p-2 hover:text-indigo-400" title="Previous"><i class="fa fa-step-backward"></i></button>
                <button onclick="playPause()" id="play-pause" class="p-2 bg-indigo-600 hover:bg-indigo-500 rounded-full w-10 h-10 flex items-center justify-center" title="Play/Pause"><i class="fa fa-play"></i></button>
                <button onclick="next()" class="p-2 hover:text-indigo-400" title="Next"><i class="fa fa-step-forward"></i></button>
                <button onclick="toggleRepeat()" id="repeat" class="p-2 hover:text-indigo-400" title="Repeat"><i class="fa fa-redo"></i></button>
            </div>
            <div class="flex items-center w-full max-w-md">
                <span id="current-time" class="text-xs mr-2">0:00</span>
                <div class="flex-grow h-1 bg-gray-600 rounded-full overflow-hidden cursor-pointer" id="progress-container" onclick="seek(event)">
                    <div id="progress-bar" class="h-full bg-indigo-500 w-0"></div>
                </div>
                <span id="duration" class="text-xs ml-2">0:00</span>
            </div>
        </div>
        <div class="flex items-center gap-3 w-1/4 justify-end">
            <button onclick="toggleQueue()" class="hover:text-indigo-400" title="Queue"><i class="fa fa-list-ul"></i></button>
            <button class="hover:text-indigo-400" title="Devices"><i class="fa fa-mobile-alt"></i></button>
            <div class="w-20 h-1 bg-gray-600 rounded-full overflow-hidden cursor-pointer" id="volume-container" onclick="adjustVolume(event)">
                <div id="volume-bar" class="h-full bg-white w-full"></div>
            </div>
            <button class="hover:text-indigo-400" title="Volume"><i class="fa fa-volume-up"></i></button>
        </div>
        <audio id="audio-player" class="hidden"></audio>
    </footer>

    <script>
        let songs = [];
        let playlists = [];
        let currentSongIndex = -1;
        let isPlaying = false;
        let isRepeat = false;
        const audio = document.getElementById('audio-player');

        // Mock data for fallback
        const mockSongs = [
            { id: '1', title: 'Blinding Lights', artist: 'The Weeknd', album: 'After Hours', duration: '3:20', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
            { id: '2', title: 'Shape of You', artist: 'Ed Sheeran', album: 'Ã·', duration: '3:53', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
            { id: '3', title: 'Bad Guy', artist: 'Billie Eilish', album: 'When We All Fall Asleep', duration: '3:14', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' }
        ];

        const mockPlaylists = [
            { id: '1', name: 'Chill Nights', songCount: 24, duration: '1h 32m' },
            { id: '2', name: 'Hot Hits', songCount: 50, duration: '3h 15m' }
        ];

        // Fetch songs from proxy
        async function fetchSongs(query = '') {
            console.log('Fetching songs:', query ? `/api/songs?query=${query}` : '/api/songs');
            try {
                const url = query ? `/api/songs?query=${encodeURIComponent(query)}` : '/api/songs';
                const response = await fetch(url);
                console.log('Songs API status:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Songs API data:', data);
                // Handle nested { songs: [...] } or flat [...]
                songs = Array.isArray(data) ? data : data.songs || [];
                if (songs.length === 0) {
                    console.warn('Empty songs array from API, using mock data');
                    songs = mockSongs;
                }
                // Filter valid songs
                songs = songs.filter(song => song.id && song.title && song.artist && song.audioUrl);
                if (songs.length === 0) {
                    console.warn('No valid songs after filtering, using mock data');
                    songs = mockSongs;
                }
                updateQueue(songs);
                updateSearchResults(songs);
                if (data.currentSong) {
                    currentSongIndex = songs.findIndex(song => song.id === data.currentSong.id);
                    if (currentSongIndex >= 0) {
                        playSong(currentSongIndex);
                    }
                }
            } catch (err) {
                console.error('Songs API error:', err.message);
                showError(`Failed to fetch songs: ${err.message}. Using mock data.`);
                songs = mockSongs;
                updateQueue(songs);
                updateSearchResults(songs);
            }
        }

        // Fetch playlists
        async function fetchPlaylists() {
            console.log('Fetching playlists: /api/playlists');
            try {
                const response = await fetch('/api/playlists');
                console.log('Playlists API status:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Playlists API data:', data);
                playlists = Array.isArray(data) ? data : data.playlists || [];
                if (playlists.length === 0) {
                    console.warn('Empty playlists array, using mock data');
                    playlists = mockPlaylists;
                }
                updatePlaylists(playlists);
                updateHomePlaylists(playlists);
                updateLibraryContent();
            } catch (err) {
                console.error('Playlists API error:', err.message);
                showError(`Failed to fetch playlists: ${err.message}. Using mock data.`);
                playlists = mockPlaylists;
                updatePlaylists(playlists);
                updateHomePlaylists(playlists);
                updateLibraryContent();
            }
        }

        // Fetch playlist songs
        async function fetchPlaylistSongs(playlistId) {
            console.log(`Fetching playlist songs: /api/playlists/${playlistId}/songs`);
            try {
                const response = await fetch(`/api/playlists/${playlistId}/songs`);
                console.log('Playlist Songs API status:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Playlist Songs API data:', data);
                songs = Array.isArray(data) ? data : data.songs || [];
                if (songs.length === 0) {
                    console.warn('Empty playlist songs, using mock data');
                    songs = mockSongs;
                }
                songs = songs.filter(song => song.id && song.title && song.artist && song.audioUrl);
                updateQueue(songs);
                updateSearchResults(songs);
                currentSongIndex = -1;
                updatePlayer(null);
                showHome();
            } catch (err) {
                console.error('Playlist Songs API error:', err.message);
                showError(`Failed to fetch playlist songs: ${err.message}. Using mock data.`);
                songs = mockSongs;
                updateQueue(songs);
                updateSearchResults(songs);
                showHome();
            }
        }

        // Update playlists (sidebar)
        function updatePlaylists(playlistsList) {
            const playlistsListEl = document.getElementById('playlists-list');
            playlistsListEl.innerHTML = '';
            playlistsList.forEach(playlist => {
                const li = document.createElement('li');
                li.className = 'p-2 hover:bg-gray-700 rounded cursor-pointer text-sm';
                li.textContent = playlist.name;
                li.onclick = () => fetchPlaylistSongs(playlist.id);
                playlistsListEl.appendChild(li);
            });
        }

        // Update home playlists
        function updateHomePlaylists(playlistsList) {
            const homePlaylists = document.getElementById('home-playlists');
            homePlaylists.innerHTML = '';
            playlistsList.forEach(playlist => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-4 rounded-lg shadow-lg flex items-center hover:bg-gray-700 cursor-pointer';
                div.innerHTML = `
                    <div class="w-16 h-16 bg-gray-700 flex items-center justify-center text-2xl rounded mr-4">ðŸŽµ</div>
                    <div>
                        <h3 class="font-bold">${playlist.name}</h3>
                        <p class="text-gray-400 text-sm">Playlist â€¢ ${playlist.songCount} songs</p>
                    </div>
                `;
                div.onclick = () => fetchPlaylistSongs(playlist.id);
                homePlaylists.appendChild(div);
            });
        }

        // Update library content
        function updateLibraryContent() {
            const libraryContent = document.getElementById('library-content');
            libraryContent.innerHTML = '';
            playlists.forEach(playlist => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-4 rounded-lg shadow-lg flex items-center hover:bg-gray-700 cursor-pointer';
                div.innerHTML = `
                    <div class="w-16 h-16 bg-gray-700 flex items-center justify-center text-2xl rounded mr-4">ðŸ“š</div>
                    <div>
                        <h3 class="font-bold">${playlist.name}</h3>
                        <p class="text-gray-400 text-sm">Playlist â€¢ ${playlist.songCount} songs</p>
                    </div>
                `;
                div.onclick = () => fetchPlaylistSongs(playlist.id);
                libraryContent.appendChild(div);
            });
        }

        // Update queue
        function updateQueue(songsList) {
            const queueList = document.getElementById('queue-list');
            queueList.innerHTML = '';
            songsList.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = `p-2 hover:bg-gray-700 rounded cursor-pointer flex justify-between items-center ${index === currentSongIndex ? 'bg-gray-700' : ''}`;
                li.innerHTML = `
                    <span>${song.title} - ${song.artist}</span>
                    <p class="text-gray-500 text-sm">${song.duration}</p>
                `;
                li.onclick = () => playSong(index);
                queueList.appendChild(li);
            });
        }

        // Update search results
        function updateSearchResults(filteredSongs) {
            const searchSection = document.getElementById('search-results-section');
            const searchResults = document.getElementById('search-results');
            const homeSection = document.getElementById('home-section');
            const librarySection = document.getElementById('library-section');
            const query = document.getElementById('search-input').value.trim();
            if (query && filteredSongs.length > 0) {
                searchSection.classList.remove('hidden');
                homeSection.classList.add('hidden');
                librarySection.classList.add('hidden');
            } else {
                searchSection.classList.add('hidden');
                if (document.querySelector('#library-section:not(.hidden)')) {
                    librarySection.classList.remove('hidden');
                } else {
                    homeSection.classList.remove('hidden');
                }
            }
            searchResults.innerHTML = '';
            filteredSongs.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded-lg shadow-lg cursor-pointer hover:bg-gray-700 flex items-center';
                div.innerHTML = `
                    <div class="w-10 h-10 bg-gray-700 rounded mr-3 flex items-center justify-center text-sm">${index + 1}</div>
                    <div class="flex-grow">
                        <h3 class="font-medium">${song.title}</h3>
                        <p class="text-gray-400 text-sm">${song.artist} â€¢ ${song.album}</p>
                    </div>
                    <p class="text-gray-500 text-sm">${song.duration}</p>
                `;
                div.onclick = () => playSong(index);
                searchResults.appendChild(div);
            });
        }

        // Update player
        function updatePlayer(song) {
            document.getElementById('song-title').textContent = song ? song.title : 'No Song Playing';
            document.getElementById('song-artist').textContent = song ? song.artist : 'Select a Song';
            document.getElementById('np-title').textContent = song ? song.title : 'No Song Playing';
            document.getElementById('np-artist').textContent = song ? song.artist : 'Select a Song';
            document.getElementById('np-album').textContent = song ? song.album : 'N/A';
            if (song && song.audioUrl) {
                audio.src = song.audioUrl;
                console.log('Setting audio src:', song.audioUrl);
            } else {
                audio.src = '';
                console.warn('No valid audioUrl for song:', song);
            }
            const volumeContainer = document.getElementById('volume-container');
            audio.volume = volumeContainer ? (document.getElementById('volume-bar').offsetWidth / 80) : 1;
            updateQueue(songs);
        }

        // Play a song
        function playSong(index) {
            if (index >= 0 && index < songs.length) {
                currentSongIndex = index;
                updatePlayer(songs[index]);
                audio.play().then(() => {
                    isPlaying = true;
                    document.getElementById('play-pause').innerHTML = '<i class="fa fa-pause"></i>';
                    console.log('Playing song:', songs[index].title);
                }).catch(err => {
                    console.error('Playback failed:', err);
                    showError('Playback error: ' + err.message + '. Check if audioUrl is valid.');
                });
            }
        }

        // Player controls
        function playPause() {
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                document.getElementById('play-pause').innerHTML = '<i class="fa fa-play"></i>';
            } else if (currentSongIndex >= 0) {
                audio.play().then(() => {
                    isPlaying = true;
                    document.getElementById('play-pause').innerHTML = '<i class="fa fa-pause"></i>';
                }).catch(err => {
                    console.error('Playback failed:', err);
                    showError('Playback error: ' + err.message);
                });
            }
        }

        function next() {
            if (currentSongIndex < songs.length - 1) {
                playSong(currentSongIndex + 1);
            } else if (isRepeat) {
                playSong(0);
            }
        }

        function previous() {
            if (currentSongIndex > 0) {
                playSong(currentSongIndex - 1);
            } else if (isRepeat) {
                playSong(songs.length - 1);
            }
        }

        function shuffle() {
            songs = [...songs].sort(() => Math.random() - 0.5);
            currentSongIndex = 0;
            updateQueue(songs);
            updateSearchResults(songs);
            playSong(0);
        }

        function toggleRepeat() {
            isRepeat = !isRepeat;
            document.getElementById('repeat').classList.toggle('text-indigo-400', isRepeat);
        }

        function toggleQueue() {
            const queueSidebar = document.getElementById('queue-sidebar');
            queueSidebar.classList.toggle('hidden');
        }

        function seek(event) {
            const progressContainer = document.getElementById('progress-container');
            if (audio.duration && progressContainer) {
                const rect = progressContainer.getBoundingClientRect();
                const pos = (event.clientX - rect.left) / rect.width;
                audio.currentTime = pos * audio.duration;
                console.log('Seeking to:', audio.currentTime);
            }
        }

        function adjustVolume(event) {
            const volumeContainer = document.getElementById('volume-container');
            if (volumeContainer) {
                const rect = volumeContainer.getBoundingClientRect();
                const pos = Math.min(Math.max((event.clientX - rect.left) / rect.width, 0), 1);
                audio.volume = pos;
                document.getElementById('volume-bar').style.width = `${pos * 100}%`;
                console.log('Volume set to:', pos);
            }
        }

        audio.ontimeupdate = () => {
            const currentTime = document.getElementById('current-time');
            const progressBar = document.getElementById('progress-bar');
            const duration = audio.duration || 0;
            const current = audio.currentTime || 0;
            currentTime.textContent = formatTime(current);
            document.getElementById('duration').textContent = formatTime(duration);
            if (progressBar && duration > 0) {
                progressBar.style.width = `${(current / duration) * 100}%`;
            }
        };

        audio.onended = () => next();

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${min}:${sec}`;
        }

        function showError(message) {
            console.error(message);
            alert(message); // Replace with toast notification in production
        }

        function showHome() {
            document.getElementById('home-section').classList.remove('hidden');
            document.getElementById('library-section').classList.add('hidden');
            document.getElementById('search-results-section').classList.add('hidden');
            document.getElementById('search-input').value = '';
            fetchSongs();
        }

        function showLibrary() {
            document.getElementById('home-section').classList.add('hidden');
            document.getElementById('library-section').classList.remove('hidden');
            document.getElementById('search-results-section').classList.add('hidden');
            document.getElementById('search-input').value = '';
            updateLibraryContent();
        }

        // Search with debounce
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            searchTimeout = setTimeout(() => {
                if (query.length < 2) {
                    fetchSongs('');
                    return;
                }
                fetchSongs(query);
            }, 300); // 300ms debounce
        });

        // Initialize
        window.onload = () => {
            console.log('Initializing MusicPioneer...');
            fetchSongs();
            fetchPlaylists();
        };
    </script>
</body>
</html>
